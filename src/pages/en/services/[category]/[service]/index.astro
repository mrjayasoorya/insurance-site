---
// src/pages/en/services/[category]/[service]/index.astro

import DesktopHero from "../../../../../components/DesktopHero.astro";
import MobileHero from "../../../../../components/MobileHero.astro";
import MobileAccordion from "../../../../../components/MobileAccordion.astro";
import FooterCtaBar from "../../../../../components/FooterCtaBar.astro";
import FloatingContactCta from "src/components/FloatingContactCta.astro";
import FloatingMenu from "src/components/FloatingMenu.astro";
import BacklinksRow from "src/components/BacklinksRow.astro";
import QuickHelpLinks from "src/components/QuickHelpLinks.astro";
import ServiceLocalSupport from "src/components/ServiceLocalSupport.astro";

import { siteData, EN, SERVICE_LOCAL_SUPPORT } from "../../../../../content/siteData";
import { buildMeta, buildJsonLd, canonicalFromPath } from "../../../../../lib/seo";

export async function getStaticPaths() {
  const all = siteData?.servicesDetail || {};
  const paths = [];
  for (const category of Object.keys(all)) {
    const services = all[category] || {};
    for (const service of Object.keys(services)) {
      paths.push({ params: { category, service } });
    }
  }
  return paths;
}

const { category, service: serviceSlug } = Astro.params;
const data = siteData?.servicesDetail?.[category]?.[serviceSlug];
if (!data) throw new Error(`Unknown service: ${category}/${serviceSlug}`);

const canonical = canonicalFromPath(siteData.brand.websiteUrl, `/en/services/${category}/${serviceSlug}/`);

const meta = buildMeta({
  title: `${data.seoTitle} | ${siteData.brand.name}`,
  description: data.seoDesc,
  canonical,
  ogType: "article",
});

const jsonLd = buildJsonLd({
  pageType: "serviceDetail",
  siteData,
  canonical,
  title: meta.title,
  description: meta.description,
  serviceData: data,
  breadcrumbs: [
    { name: "Home", href: "/en/" },
    { name: "Services", href: "/en/services/" },
    { name: category, href: `/en/services/${category}/` },
    { name: data.heroH1, href: canonical },
  ],
  faqs: data.faqs || [],
});

// ---- Local Support (service-specific mapping; avoids templated lists) ----
const localSupportSlugs =
  SERVICE_LOCAL_SUPPORT?.[category]?.[serviceSlug] || [];

// ---- At-a-glance fields (high-weight content early) ----
// Keep these short and factual; bots read this well.
const atAGlance = [
  { k: "Best for", v: (data.whoFor || []).slice(0, 2).join(" • ") },
  { k: "Core focus", v: (data.keyCoverFocus || []).slice(0, 2).join(" • ") },
  { k: "Claim sensitivity", v: (data.whatCanGoWrong || []).slice(0, 2).join(" • ") },
  { k: "Documents", v: (data.claimDocs || []).slice(0, 2).join(" • ") },
].filter((x) => x.v);

// ---- Helper to build interlink cards with better descriptions ----
const linkCards = (data.internalLinks || []).map((l) => ({
  ...l,
  desc:
    l.desc ||
    "Related guidance page for coverage logic, documents and common mistakes (claim-ready).",
}));

// Optional: intent links (use existing intent pages)
const intentCards = [
  {
    title: "Insurance near me",
    desc: "How local support works (visit vs WhatsApp/phone), document checklist, and when insurer inspections apply.",
    href: EN("/insurance-near-me/"),
  },
  {
    title: "Insurance renewal near me",
    desc: "Renewal checks (IDV/NCB/add-ons; permits/fitness as applicable) to avoid gaps and disputes.",
    href: EN("/insurance-renewal-near-me/"),
  },
  {
    title: "Insurance claim help",
    desc: "What to do first, what proof matters, and how to keep a clean incident timeline.",
    href: EN("/insurance-claim-help/"),
  },
];
---

<html lang="en">
  <head>
    <title>{meta.title}</title>
    <meta name="description" content={meta.description} />
    <link rel="canonical" href={meta.canonical} />
    {Object.entries(meta.tags).map(([k, v]) => <meta property={k} content={v} />)}
    {Object.entries(meta.nameTags || {}).map(([k, v]) => <meta name={k} content={v} />)}
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <meta name="googlebot" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <link rel="stylesheet" href="/styles/theme.css" />
  </head>

  <body>
    <main class="app">
      <div class="container">

        <!-- ========================= DESKTOP ========================= -->
        <div class="ui-desktop">
          <header>
            <DesktopHero
              brand={{
                name: siteData.brand.name,
                tagline: siteData.brand.tagline,
                subtitle: data.heroP,
                phone: siteData.brand.phone,
                areaChips: siteData.brand.areaChips,
              }}
            />
          </header>

          <!-- H1 + clear positioning -->
          <section class="section section-padding" aria-label="Service overview">
            <h1 class="section-title">{data.heroH1}</h1>
            <p class="section-sub readable">{data.heroP}</p>
          </section>

          <!-- At a glance (high-weight, reduces “thin” perception) -->
          {atAGlance.length ? (
            <section class="section section-padding" aria-label="At a glance">
              <h2 class="section-title">At a glance</h2>
              <div class="glance">
                {atAGlance.map((x) => (
                  <div class="glance-row">
                    <div class="glance-k">{x.k}</div>
                    <div class="glance-v">{x.v}</div>
                  </div>
                ))}
              </div>
            </section>
          ) : null}

          <!-- Claim-first positioning (your USP) -->
          {data.claimDiscipline?.title ? (
            <section class="section section-padding" aria-label="Claim-first guidance">
              <h2 class="section-title">{data.claimDiscipline.title}</h2>
              {data.claimDiscipline.intro ? (
                <p class="section-sub readable">{data.claimDiscipline.intro}</p>
              ) : null}
              {data.claimDiscipline.bullets?.length ? (
                <ul class="bullets">
                  {data.claimDiscipline.bullets.map((x) => <li>{x}</li>)}
                </ul>
              ) : null}
            </section>
          ) : null}

          <!-- Local Support (Service -> Location silo) -->
          <ServiceLocalSupport
            title={`Local support for ${data.heroH1 || "this service"}`}
            subtitle="These location pages explain local context + typical needs. Support is coordinated from Sholavaram (no fake branch offices)."
            slugs={localSupportSlugs}
            max={10}
          />

          <!-- Standard modules (very important for MSME/warehouse/fire) -->
          {data.standardModules?.bullets?.length ? (
            <section class="section section-padding" aria-label="Coverage modules">
              <h2 class="section-title">{data.standardModules.title || "Standard coverage modules"}</h2>
              <p class="section-sub readable">
                Modules and add-ons vary by insurer and business type. The goal is to match wording to real operations and keep proof discipline defensible.
              </p>
              <ul class="bullets">
                {data.standardModules.bullets.map((x) => <li>{x}</li>)}
              </ul>
            </section>
          ) : null}

          <!-- Who for -->
          {data.whoFor?.length ? (
            <section class="section section-padding" aria-label="Who this is for">
              <h2 class="section-title">Who this is for</h2>
              <ul class="bullets">{data.whoFor.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          <!-- What can go wrong -->
          {data.whatCanGoWrong?.length ? (
            <section class="section section-padding" aria-label="What can go wrong">
              <h2 class="section-title">What commonly causes claim disputes or delays</h2>
              <p class="section-sub readable">
                This is not fear content—these are the avoidable reasons claims get stuck: mismatched disclosures, weak timelines, missing proofs, and condition gaps.
              </p>
              <ul class="bullets">{data.whatCanGoWrong.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          <!-- Focus + docs + mistakes (your existing structure, but framed better) -->
          {data.keyCoverFocus?.length ? (
            <section class="section section-padding" aria-label="What we focus on">
              <h2 class="section-title">What we focus on (claim-first)</h2>
              <ul class="bullets">{data.keyCoverFocus.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          {data.claimDocs?.length ? (
            <section class="section section-padding" aria-label="Documents checklist">
              <h2 class="section-title">Documents that protect claim momentum</h2>
              <p class="section-sub readable">
                These documents are not always mandatory in every case—but missing them is a frequent reason for delays and valuation disputes.
              </p>
              <ul class="bullets">{data.claimDocs.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          {data.commonMistakes?.length ? (
            <section class="section section-padding" aria-label="Common mistakes">
              <h2 class="section-title">Common mistakes we help prevent</h2>
              <ul class="bullets">{data.commonMistakes.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          <!-- Pre-buy / renewal checklist (optional) -->
          {data.preBuyChecklist?.bullets?.length ? (
            <section class="section section-padding" aria-label="Before you buy or renew">
              <h2 class="section-title">{data.preBuyChecklist.title || "Before you buy or renew"}</h2>
              <ul class="bullets">{data.preBuyChecklist.bullets.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          <!-- Pricing/acceptance factors (optional but strong for indexing) -->
          {data.pricingFactors?.bullets?.length ? (
            <section class="section section-padding" aria-label="Pricing factors">
              <h2 class="section-title">{data.pricingFactors.title || "What affects premium and acceptance"}</h2>
              <p class="section-sub readable">
                We do not publish pricing because it depends on insurer rules and disclosures. This section explains the variables that change pricing and claim outcomes.
              </p>
              <ul class="bullets">{data.pricingFactors.bullets.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          <!-- Local context + synonyms -->
          {data.localFit ? (
            <section class="section section-padding" aria-label="Local context">
              <h2 class="section-title">Local context</h2>
              <p class="section-sub readable">{data.localFit}</p>
            </section>
          ) : null}

          {data.alsoKnownAs?.length ? (
            <section class="section section-padding" aria-label="Also known as">
              <h2 class="section-title">Also known as</h2>
              <p class="section-sub readable">{data.alsoKnownAs.join(" • ")}</p>
            </section>
          ) : null}

          {data.areaRealityTitle && data.areaRealityText ? (
            <section class="section section-padding" aria-label="Area reality">
              <h2 class="section-title">{data.areaRealityTitle}</h2>
              <p class="section-sub readable">{data.areaRealityText}</p>
            </section>
          ) : null}

          {data.areaSignals?.length ? (
            <section class="section section-padding" aria-label="Local signals">
              <h2 class="section-title">Search signals people use</h2>
              <p class="section-sub readable">{data.areaSignals.join(" • ")}</p>
            </section>
          ) : null}

          <!-- Intent links (semantic + conversion) -->
          <section class="section section-padding" aria-label="Quick actions">
            <h2 class="section-title">Quick actions</h2>
            <div class="grid grid-2">
              {intentCards.map((c) => (
                <a class="card" href={c.href}>
                  <h3 class="card-title">{c.title}</h3>
                  <p class="card-desc readable">{c.desc}</p>
                </a>
              ))}
            </div>
          </section>

          <!-- Visible FAQ (important) -->
          {data.faqs?.length ? (
            <section class="section section-padding" aria-label="FAQs">
              <h2 class="section-title">FAQs</h2>
              <MobileAccordion
                sections={[{
                  title: "Questions people ask",
                  items: data.faqs.map((f) => ({ strong: f.q, text: f.a })),
                }]}
                defaultOpen={true}
              />
            </section>
          ) : null}

          <!-- Complementary protection (semantic web / “related risks”) -->
          {linkCards.length ? (
            <section class="section section-padding" aria-label="Complementary business protection">
              <h2 class="section-title">Complementary protection (related risks)</h2>
              <p class="section-sub readable">
                Businesses rarely have only one risk. These pages cover adjacent exposures that commonly affect renewals and claims.
              </p>
              <div class="grid grid-2">
                {linkCards.map((l) => (
                  <a class="card" href={l.href}>
                    <h3 class="card-title">{l.label}</h3>
                    <p class="card-desc readable">{l.desc}</p>
                  </a>
                ))}
              </div>
            </section>
          ) : null}

          <BacklinksRow title={siteData.backlinks.title} links={siteData.backlinks.links} />
          <QuickHelpLinks pageType="serviceDetail" />

          <FooterCtaBar
            title={siteData.footerCtas.title}
            subtitle={siteData.footerCtas.subtitle}
            whatsappNumber={siteData.brand.whatsappE164}
            whatsappText={siteData.brand.whatsappPrefill}
            callNumber={siteData.brand.phoneE164}
            callLabel={siteData.footerCtas.callLabel}
            brandName={siteData.footerCtas.brandName}
            logoText={siteData.footerCtas.logoText}
            copyright={siteData.footerCtas.copyright}
          />
        </div>

        <!-- ========================= MOBILE ========================= -->
        <div class="ui-mobile">
          <header>
            <MobileHero
              brand={{
                name: siteData.brand.name,
                tagline: siteData.brand.tagline,
                subtitle: data.heroP,
                phone: siteData.brand.phone,
                areaChips: [],
              }}
            />
          </header>

          <section class="section section-padding">
            <h1 class="section-title">{data.heroH1}</h1>
            <p class="section-sub readable">{data.heroP}</p>
          </section>

          {atAGlance.length ? (
            <section class="section section-padding">
              <h2 class="section-title">At a glance</h2>
              <div class="glance">
                {atAGlance.map((x) => (
                  <div class="glance-row">
                    <div class="glance-k">{x.k}</div>
                    <div class="glance-v">{x.v}</div>
                  </div>
                ))}
              </div>
            </section>
          ) : null}

          <!-- {data.claimDiscipline?.title ? (
            <section class="section section-padding">
              <h2 class="section-title">{data.claimDiscipline.title}</h2>
              {data.claimDiscipline.intro ? <p class="section-sub readable">{data.claimDiscipline.intro}</p> : null}
              {data.claimDiscipline.bullets?.length ? <ul class="bullets">{data.claimDiscipline.bullets.map((x) => <li>{x}</li>)}</ul> : null}
            </section>
          ) : null} -->

                    <!-- Claim-first positioning (your USP) -->
          {data.claimDiscipline?.title ? (
            <section class="section section-padding" aria-label="Claim-first guidance">
              <h2 class="section-title">{data.claimDiscipline.title}</h2>
              {data.claimDiscipline.intro ? (
                <p class="section-sub readable">{data.claimDiscipline.intro}</p>
              ) : null}
              {data.claimDiscipline.bullets?.length ? (
                <ul class="bullets">
                  {data.claimDiscipline.bullets.map((x) => <li>{x}</li>)}
                </ul>
              ) : null}
            </section>
          ) : null}

          <ServiceLocalSupport
            title={`Local support for ${data.heroH1 || "this service"}`}
            subtitle="Support is coordinated from Sholavaram; location pages provide local context + common needs."
            slugs={localSupportSlugs}
            max={10}
          />

          {data.standardModules?.bullets?.length ? (
            <section class="section section-padding">
              <h2 class="section-title">{data.standardModules.title || "Standard coverage modules"}</h2>
              <ul class="bullets">{data.standardModules.bullets.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          {data.whoFor?.length ? (
            <section class="section section-padding">
              <h2 class="section-title">Who this is for</h2>
              <ul class="bullets">{data.whoFor.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          

          {data.whatCanGoWrong?.length ? (
            <section class="section section-padding">
              <h2 class="section-title">What commonly goes wrong</h2>
              <ul class="bullets">{data.whatCanGoWrong.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}


          <!-- Focus + docs + mistakes (your existing structure, but framed better) -->
          {data.keyCoverFocus?.length ? (
            <section class="section section-padding" aria-label="What we focus on">
              <h2 class="section-title">What we focus on (claim-first)</h2>
              <ul class="bullets">{data.keyCoverFocus.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          {data.claimDocs?.length ? (
            <section class="section section-padding" aria-label="Documents checklist">
              <h2 class="section-title">Documents that protect claim momentum</h2>
              <p class="section-sub readable">
                These documents are not always mandatory in every case—but missing them is a frequent reason for delays and valuation disputes.
              </p>
              <ul class="bullets">{data.claimDocs.map((x) => <li>{x}</li>)}</ul>
            </section>
          ) : null}

          {data.faqs?.length ? (
            <section class="section section-padding">
              <h2 class="section-title">FAQs</h2>
              <MobileAccordion sections={[{ title: "Questions people ask", items: data.faqs.map((f) => ({ strong: f.q, text: f.a })) }]} defaultOpen={true} />
            </section>
          ) : null}

          {linkCards.length ? (
            <section class="section section-padding">
              <h2 class="section-title">Related risks</h2>
              <div class="grid grid-1">
                {linkCards.map((l) => (
                  <a class="card" href={l.href}>
                    <h3 class="card-title">{l.label}</h3>
                    <p class="card-desc readable">{l.desc}</p>
                  </a>
                ))}
              </div>
            </section>
          ) : null}

          <BacklinksRow title={siteData.backlinks.title} links={siteData.backlinks.links} />
          <QuickHelpLinks pageType="serviceDetail" />

          <FooterCtaBar
            title={siteData.footerCtas.title}
            subtitle={siteData.footerCtas.subtitle}
            whatsappNumber={siteData.brand.whatsappE164}
            whatsappText={siteData.brand.whatsappPrefill}
            callNumber={siteData.brand.phoneE164}
            callLabel={siteData.footerCtas.callLabel}
            brandName={siteData.footerCtas.brandName}
            logoText={siteData.footerCtas.logoText}
            copyright={siteData.footerCtas.copyright}
          />
        </div>

      </div>
    </main>

    <FloatingMenu />
    <FloatingContactCta brand={siteData.brand} />

    <style>
      .readable { max-width: 78ch; }

      .glance{
        border:1px solid var(--border);
        background: var(--surface);
        border-radius: 16px;
        padding: 10px 12px;
        display:flex;
        flex-direction:column;
        gap:10px;
        box-shadow: 0 2px 10px rgba(11,13,18,.05);
      }
      .glance-row{
        display:grid;
        grid-template-columns: 160px 1fr;
        gap: 10px;
        align-items:start;
      }
      .glance-k{
        font-weight: 950;
        opacity: .85;
        font-size: 13px;
      }
      .glance-v{
        opacity: .9;
        font-size: 13.5px;
        line-height: 1.35;
      }

      @media (max-width: 520px){
        .glance-row{ grid-template-columns: 1fr; }
      }
    </style>
  </body>
</html>
