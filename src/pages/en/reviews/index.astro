---
import DesktopHero from "../../../components/DesktopHero.astro";
import MobileHero from "../../../components/MobileHero.astro";
import FooterCtaBar from "../../../components/FooterCtaBar.astro";
import FloatingContactCta from "src/components/FloatingContactCta.astro";
import LocalIdentitySection from "../../../components/LocalIdentitySection.astro";
import { siteData, EN } from "../../../content/siteData";
import FloatingMenu from "src/components/FloatingMenu.astro";
import BacklinksRow from "src/components/BacklinksRow.astro";
import NearMeTrustSection from "src/components/NearMeTrustSection.astro";
import { buildJsonLd, buildMeta, canonicalFromPath } from "src/lib/seo";

const brand = siteData.brand;


// ✅ Reviews dataset (you will add this shape into siteData)
const reviews = siteData?.reviews?.items || [];

// ✅ Google link (use your GBP maps URL)
const googleReviewsHref = brand?.gbpUrl || "#";

// ✅ rating calc
const stars = reviews
  .map((r) => Number(r.stars))
  .filter((n) => Number.isFinite(n) && n >= 1 && n <= 5);

const reviewCount = stars.length;
const avgRating = reviewCount ? stars.reduce((a, b) => a + b, 0) / reviewCount : null;
const avgRatingStr = avgRating ? avgRating.toFixed(1) : null;


const canonical = canonicalFromPath(siteData.brand.websiteUrl, "/en/reviews/");
const meta = buildMeta({
  title: `Reviews | ${siteData.brand.name}`,
  description:
    "Google Business Profile reviews and customer feedback for M N Rajendrakumar Insurance Services (Sholavaram).",
  canonical,
  ogType: "website",
});

const jsonLd = buildJsonLd({
  pageType: "reviews",
  siteData,
  canonical,
  title: meta.title,
  description: meta.description,
  breadcrumbs: [
    { name: "Home", href: canonicalFromPath(siteData.brand.websiteUrl, "/en/") },
    { name: "Reviews", href: canonical },
  ],
  // Optional: add AggregateRating ONLY if you show an actual average + count derived from your data
});


// ✅ page copy
const pageTitle = `Reviews | ${brand.name}`;
const pageDesc =
  "Verified customer feedback from Google Business Profile — commercial, vehicle and industrial insurance guidance in Sholavaram, Red Hills Toll belt, Madhavaram and Chennai outskirts.";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

                          <title>{meta.title}</title>
  <meta name="description" content={meta.description} />
  <link rel="canonical" href={meta.canonical} />
  {Object.entries(meta.tags).map(([k,v]) => <meta property={k} content={v} />)}
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <link rel="stylesheet" href="/styles/theme.css" />
  </head>

  <body>
    <main class="app">
      <div class="container">

        <!-- =========================
             DESKTOP UI
        ========================== -->
        <div class="ui-desktop">
          <header>
            <DesktopHero
              brand={{
                name: brand.name,
                tagline: brand.tagline,
                subtitle:
                  "Verified Google Business Profile reviews — real feedback from customers across Sholavaram, Red Hills Toll belt, Madhavaram and Chennai outskirts.",
                phone: brand.phone,
                areaChips: brand.areaChips,
              }}
            />
          </header>



          <!-- ✅ Reviews header -->
          <section class="section section-padding" aria-labelledby="reviews-title">
            <div class="reviews-head">
              <div class="reviews-head__left">
                <h1 id="reviews-title" class="section-title">Google Reviews (Verified)</h1>
                <p class="section-sub">
                  These reviews are exported from our Google Business Profile. These help users to understand
                  trust, service scope, and our local coverage.
                </p>

                <ul class="reviews-stats" aria-label="Review summary">
                  <li class="reviews-stat">
                    <strong>{avgRatingStr ? `${avgRatingStr}/5` : "—"}</strong>
                    <span>Average rating</span>
                  </li>
                  <li class="reviews-stat">
                    <strong>{reviewCount ? `${reviewCount}+` : "—"}</strong>
                    <span>Reviews in dataset</span>
                  </li>
                  <li class="reviews-stat">
                    <strong>Sholavaram</strong>
                    <span>Base office</span>
                  </li>
                  <li class="reviews-stat">
                    <strong>Chennai Outskirts</strong>
                    <span>NH + industrial belts</span>
                  </li>
                </ul>
              </div>

              <div class="reviews-head__right">
                <a class="reviews-google" href={googleReviewsHref} target="_blank" rel="noopener">
                  View all reviews on Google <span aria-hidden="true">↗</span>
                </a>
              </div>
            </div>
          </section>

          <!-- ✅ Reviews list -->
          <section class="section section-padding" aria-label="Customer reviews list">
            {reviews.length ? (
              <ul class="reviews-list">
                {reviews.map((r) => (
                  <li class="reviews-item">
                    <article class="reviews-card" aria-label={`Review by ${r.name || "Customer"}`}>
                      <header class="reviews-card__head">
                        <div class="reviews-who">
                          <div class="reviews-avatar" aria-hidden="true">
                            {(r.name || "G").slice(0, 1).toUpperCase()}
                          </div>

                          <div class="reviews-meta">
                            <div class="reviews-name">
                              <strong>{r.name || "Google Reviewer"}</strong>
                              {r.createdAt ? <span class="reviews-dot" aria-hidden="true">•</span> : null}
                              {r.createdAt ? (
                                <time class="reviews-time" datetime={String(r.createdAt)}>
                                  {String(r.createdAt).slice(0, 10)}
                                </time>
                              ) : null}
                            </div>

                            <div class="reviews-stars" aria-label={`${r.stars || 5} star rating`}>
                              <span class="reviews-stars__txt" aria-hidden="true">
                                {"★".repeat(Math.max(1, Math.min(5, r.stars || 5)))}
                                {"☆".repeat(Math.max(0, 5 - Math.max(1, Math.min(5, r.stars || 5))))}
                              </span>
                              {r.replied ? <span class="reviews-pill">Reply posted</span> : null}
                            </div>
                          </div>
                        </div>

                        <a class="reviews-link" href={googleReviewsHref} target="_blank" rel="noopener">
                          Google <span aria-hidden="true">↗</span>
                        </a>
                      </header>

                      <div class="reviews-card__body">
                        <p class="reviews-quote">{r.quote || "No comment provided."}</p>

                        {r.replied && r.reply ? (
                          <div class="reviews-reply" aria-label="Owner reply">
                            <div class="reviews-reply__row">
                              <strong>Owner reply</strong>
                              {r.replyAt ? (
                                <time class="reviews-time" datetime={String(r.replyAt)}>
                                  {String(r.replyAt).slice(0, 10)}
                                </time>
                              ) : null}
                            </div>
                            <p class="reviews-reply__text">{r.reply}</p>
                          </div>
                        ) : null}
                      </div>
                    </article>
                  </li>
                ))}
              </ul>
            ) : (
              <p class="section-sub">No reviews found in dataset yet.</p>
            )}
          </section>
          <!-- ✅ Up-front identity section (bots + LLMs) -->
          <section class="" aria-label="Local identity">
            <LocalIdentitySection brand={brand} pageTitle="Reviews" />
          </section>
                    <section
            class="section section-padding"
            aria-label="Areas we commonly serve"
          >
            <h2 class="section-title">Areas We Commonly Serve</h2>
            <p class="section-sub readable">
              Browse location pages for local context and the services commonly
              supported there.
            </p>

            <div class="grid grid-2">
              {
                siteData.locationsIndex?.groups
                  ?.flatMap((g) => g.locations || [])
                  .slice(0, 12)
                  .map((loc) => (
                    <a class="card" href={EN(`/locations/${loc.slug}/`)}>
                      <h3 class="card-title">{loc.name}</h3>
                      <p class="card-desc">Open local service guide</p>
                    </a>
                  ))
              }
            </div>

            <p class="section-sub" style="margin-top:12px">
              <a class="chiplink" href={EN("/locations/")}>View all locations</a
              >
            </p>
          </section>
          <NearMeTrustSection data={{nearMeIntent: siteData.nearMeIntent, trustValidation: siteData.trustValidation}} />
          <BacklinksRow title={siteData.backlinks.title} links={siteData.backlinks.links} />
          <!-- ✅ CTA -->
          <section aria-label="Footer CTA">
            <FooterCtaBar
              title={siteData.footerCtas.title}
              subtitle={siteData.footerCtas.subtitle}
              whatsappNumber={brand.whatsappE164}
              whatsappText={brand.whatsappPrefill}
              callNumber={brand.phoneE164}
              callLabel={siteData.footerCtas.callLabel}
              brandName={siteData.footerCtas.brandName}
              logoText={siteData.footerCtas.logoText}
              copyright={siteData.footerCtas.copyright}
            />
          </section>
        </div>

        <!-- =========================
             MOBILE UI
        ========================== -->
        <div class="ui-mobile">
          <header>
            <MobileHero
              brand={{
                name: brand.name,
                tagline: brand.tagline,
                subtitle:
                  "Verified Google reviews — trust signals for customers across Sholavaram, Red Hills Toll belt, Madhavaram and Chennai outskirts.",
                phone: brand.phone,
                areaChips: [],
              }}
            />
          </header>

          <!-- ✅ Up-front identity section (bots + LLMs) -->
          <section class="" aria-label="Local identity">
            <LocalIdentitySection brand={brand} pageTitle="Reviews" />
          </section>

          <section class="section section-padding" aria-labelledby="m-reviews-title">
            <h1 id="m-reviews-title" class="section-title">Google Reviews (Verified)</h1>
            <p class="section-sub">
              Exported from our Google Business Profile to improve crawling and trust signals.
            </p>

            <ul class="reviews-stats" aria-label="Review summary">
              <li class="reviews-stat">
                <strong>{avgRatingStr ? `${avgRatingStr}/5` : "—"}</strong>
                <span>Average</span>
              </li>
              <li class="reviews-stat">
                <strong>{reviewCount ? `${reviewCount}+` : "—"}</strong>
                <span>Reviews</span>
              </li>
              <li class="reviews-stat">
                <strong>Sholavaram</strong>
                <span>Base</span>
              </li>
            </ul>

            <a class="reviews-google" href={googleReviewsHref} target="_blank" rel="noopener">
              View all on Google <span aria-hidden="true">↗</span>
            </a>
          </section>

          <section class="section section-padding" aria-label="Customer reviews list">
            {reviews.length ? (
              <ul class="reviews-list">
                {reviews.map((r) => (
                  <li class="reviews-item">
                    <article class="reviews-card" aria-label={`Review by ${r.name || "Customer"}`}>
                      <header class="reviews-card__head">
                        <div class="reviews-who">
                          <div class="reviews-avatar" aria-hidden="true">
                            {(r.name || "G").slice(0, 1).toUpperCase()}
                          </div>

                          <div class="reviews-meta">
                            <div class="reviews-name">
                              <strong>{r.name || "Google Reviewer"}</strong>
                              {r.createdAt ? <span class="reviews-dot" aria-hidden="true">•</span> : null}
                              {r.createdAt ? (
                                <time class="reviews-time" datetime={String(r.createdAt)}>
                                  {String(r.createdAt).slice(0, 10)}
                                </time>
                              ) : null}
                            </div>

                            <div class="reviews-stars" aria-label={`${r.stars || 5} star rating`}>
                              <span class="reviews-stars__txt" aria-hidden="true">
                                {"★".repeat(Math.max(1, Math.min(5, r.stars || 5)))}
                                {"☆".repeat(Math.max(0, 5 - Math.max(1, Math.min(5, r.stars || 5))))}
                              </span>
                              {r.replied ? <span class="reviews-pill">Reply posted</span> : null}
                            </div>
                          </div>
                        </div>
                      </header>

                      <div class="reviews-card__body">
                        <p class="reviews-quote">{r.quote || "No comment provided."}</p>

                        {r.replied && r.reply ? (
                          <div class="reviews-reply" aria-label="Owner reply">
                            <div class="reviews-reply__row">
                              <strong>Owner reply</strong>
                              {r.replyAt ? (
                                <time class="reviews-time" datetime={String(r.replyAt)}>
                                  {String(r.replyAt).slice(0, 10)}
                                </time>
                              ) : null}
                            </div>
                            <p class="reviews-reply__text">{r.reply}</p>
                          </div>
                        ) : null}
                      </div>
                    </article>
                  </li>
                ))}
              </ul>
            ) : (
              <p class="section-sub">No reviews found in dataset yet.</p>
            )}
          </section>
                    <section
            class="section section-padding"
            aria-label="Areas we commonly serve"
          >
            <h2 class="section-title">Areas We Commonly Serve</h2>
            <p class="section-sub readable">
              Browse location pages for local context and the services commonly
              supported there.
            </p>

            <div class="grid grid-2">
              {
                siteData.locationsIndex?.groups
                  ?.flatMap((g) => g.locations || [])
                  .slice(0, 12)
                  .map((loc) => (
                    <a class="card" href={EN(`/locations/${loc.slug}/`)}>
                      <h3 class="card-title">{loc.name}</h3>
                      <p class="card-desc">Open local service guide</p>
                    </a>
                  ))
              }
            </div>

            <p class="section-sub" style="margin-top:12px">
              <a class="chiplink" href={EN("/locations/")}>View all locations</a
              >
            </p>
          </section>
          <NearMeTrustSection data={{nearMeIntent: siteData.nearMeIntent, trustValidation: siteData.trustValidation}} />
<BacklinksRow title={siteData.backlinks.title} links={siteData.backlinks.links} />
          <section aria-label="Footer CTA">
            <FooterCtaBar
              title={siteData.footerCtas.title}
              subtitle={siteData.footerCtas.subtitle}
              whatsappNumber={brand.whatsappE164}
              whatsappText={brand.whatsappPrefill}
              callNumber={brand.phoneE164}
              callLabel={siteData.footerCtas.callLabel}
              brandName={siteData.footerCtas.brandName}
              logoText={siteData.footerCtas.logoText}
              copyright={siteData.footerCtas.copyright}
            />
          </section>
        </div>
      </div>
    </main>
    <FloatingMenu />
    <FloatingContactCta brand={brand} />

    <!-- ✅ Reviews page only CSS (tight + fixes padding/spacing) -->
    <style is:global>
      .reviews-head{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 14px;
        flex-wrap:wrap;
      }
      .reviews-head__left{
        min-width: 0;
        flex: 1;
      }

      /* keep same theme spacing rhythm */
      .reviews-stats{
        list-style:none;
        padding:0;
        margin: 14px 0 0;
        display:flex;
        flex-wrap:wrap;
        gap: 10px;
      }
      .reviews-stat{
        display:flex;
        align-items:center;
        gap: 10px;
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: 0 1px 0 rgba(11,13,18,.04);
      }
      .reviews-stat strong{
        font-weight: 950;
        letter-spacing: -0.01em;
      }
      .reviews-stat span{
        color: var(--muted);
        font-size: 12.5px;
      }

      .reviews-google{
        display:inline-flex;
        align-items:center;
        gap: 8px;
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: 0 1px 0 rgba(11,13,18,.04);
        color: var(--muted);
        font-weight: 800;
        font-size: 12.5px;
        white-space:nowrap;
      }

      .reviews-list{
        list-style:none;
        padding:0;
        margin: 0;
        display:flex;
        flex-direction:column;
        gap: 12px;
      }

      .reviews-card{
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        padding: 14px 14px;
      }

      .reviews-card__head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        flex-wrap:wrap;
        margin-bottom: 10px;
      }

      .reviews-who{
        display:flex;
        align-items:center;
        gap: 12px;
        min-width:0;
        flex: 1;
      }

      .reviews-avatar{
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface-2);
        display:grid;
        place-items:center;
        font-weight: 950;
        flex: 0 0 auto;
      }

      .reviews-meta{ min-width:0; }
      .reviews-name{
        display:flex;
        align-items:center;
        gap: 8px;
        flex-wrap:wrap;
        line-height: 1.2;
      }
      .reviews-time{
        color: var(--muted);
        font-size: 12.5px;
      }
      .reviews-dot{ color: var(--muted); }

      .reviews-stars{
        display:flex;
        align-items:center;
        gap: 10px;
        flex-wrap:wrap;
        margin-top: 6px;
      }
      .reviews-stars__txt{
        letter-spacing: .06em;
        font-size: 14px;
      }

      .reviews-pill{
        height: 26px;
        padding: 0 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface);
        font-size: 12px;
        font-weight: 800;
        color: var(--muted);
        display:flex;
        align-items:center;
      }

      .reviews-link{
        display:inline-flex;
        align-items:center;
        gap: 8px;
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 8px 10px;
        box-shadow: 0 1px 0 rgba(11,13,18,.04);
        color: var(--muted);
        font-weight: 800;
        font-size: 12.5px;
        white-space:nowrap;
      }

      .reviews-quote{
        margin: 0;
        line-height: 1.55;
      }

      .reviews-reply{
        margin-top: 10px;
        border: 1px solid var(--border);
        background: var(--surface-2);
        border-radius: var(--radius-md);
        padding: 12px 12px;
      }
      .reviews-reply__row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 10px;
        flex-wrap:wrap;
        margin-bottom: 6px;
      }
      .reviews-reply__text{
        margin: 0;
        color: var(--muted);
        line-height: 1.55;
      }

      /* mobile: avoid “content hidden” feeling */
      @media (max-width: 820px){
        .reviews-card{ padding: 12px 12px; }
        .reviews-stat{ padding: 9px 10px; }
        .reviews-google{ width:100%; justify-content:center; }
      }
    </style>
  </body>
</html>
