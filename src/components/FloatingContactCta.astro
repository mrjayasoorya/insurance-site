---
// src/components/FloatingContactCta.astro
// BaseLayout-safe: overlay is portalled to <body> via JS.
// Desktop: clean popover card (bottom-right)
// Mobile: bottom sheet (your "pakka" style)

const { brand } = Astro.props;

const telHref = `tel:${brand?.phoneE164 || ""}`;
const waHref =
  `https://wa.me/${encodeURIComponent(brand?.whatsappE164 || "")}` +
  `?text=${encodeURIComponent(
    brand?.whatsappPrefill || "Hi, I need help choosing the right insurance plan."
  )}`;

const mapsHref = brand?.gbpUrl || brand?.mapUrl || "#";

const addrLine =
  brand?.streetAddress
    ? `${brand.streetAddress}, ${brand.addressLocality}, ${brand.addressRegion} ${brand.postalCode || ""}`
    : "";
---

<!-- Floating Button (stays where component is rendered) -->
<button
  class="fc2-btn"
  type="button"
  aria-haspopup="dialog"
  aria-expanded="false"
  data-fc2-trigger
>
  <span class="fc2-ring" aria-hidden="true"></span>
  <span class="fc2-ico" aria-hidden="true">☎</span>


  <span class="fc2-textwrap">
  <span class="fc2-label">Contact Details</span>
  <span class="fc2-subtxt">Tap to open WhatsApp • Call • Map</span>
</span>
</button>


<!-- Overlay template (will be moved to document.body on load) -->
<div class="fc2-overlay" hidden data-fc2-overlay>
  <div class="fc2-backdrop" data-fc2-close aria-hidden="true"></div>

  <!-- Desktop Popover -->
  <section
    class="fc2-pop"
    role="dialog"
    aria-modal="true"
    aria-labelledby="fc2-title"
    tabindex="-1"
    data-fc2-panel="desktop"
  >
    <button class="fc2-x" type="button" aria-label="Close" data-fc2-close>×</button>

    <header class="fc2-head">
      <div class="fc2-badge" aria-hidden="true">NIA</div>
      <div class="fc2-htext">
        <h3 id="fc2-title" class="fc2-title">{brand?.name || "Insurance Services"}</h3>
        <p class="fc2-sub">
          {brand?.primaryArea || "Chennai Outskirts"} • {brand?.hours?.label || "Open 24 hours"}
        </p>
      </div>
    </header>

    <div class="fc2-body">
      <div class="fc2-info">
        <div class="fc2-row">
          <span class="fc2-k">Phone</span>
          <a class="fc2-v fc2-link" href={telHref}>
            {brand?.phone || brand?.phoneE164}
          </a>
        </div>

        <div class="fc2-row">
          <span class="fc2-k">Google</span>
          {mapsHref !== "#" ? (
            <a class="fc2-v fc2-link" href={mapsHref} target="_blank" rel="noopener">
              Open Business Profile / Maps
            </a>
          ) : (
            <span class="fc2-v fc2-muted">Add gbpUrl</span>
          )}
        </div>

        <div class="fc2-row">
          <span class="fc2-k">Address</span>
          {addrLine ? (
            <span class="fc2-v">{addrLine}</span>
          ) : (
            <span class="fc2-v fc2-muted">Add streetAddress in siteData.brand</span>
          )}
        </div>
      </div>

      <div class="fc2-actions">
        <a class="fc2-a fc2-a--primary" href={telHref}>
          Call {brand?.phone ? brand.phone.replace(/\s+/g, "") : ""}
        </a>
        <a class="fc2-a" href={waHref} target="_blank" rel="noopener">WhatsApp</a>
        {mapsHref !== "#" ? (
          <a class="fc2-a" href={mapsHref} target="_blank" rel="noopener">Maps</a>
        ) : null}
      </div>

      {brand?.mapEmbedUrl ? (
        <div class="fc2-map" role="group" aria-label="Map preview">
          <iframe
            src={brand.mapEmbedUrl}
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            allowfullscreen
            title={`${brand?.name || "Business"} map`}
          ></iframe>
        </div>
      ) : null}
    </div>
  </section>

  <!-- Mobile Bottom Sheet -->
  <section
    class="fc2-sheet"
    role="dialog"
    aria-modal="true"
    aria-labelledby="fc2-title-m"
    tabindex="-1"
    data-fc2-panel="mobile"
  >
    <div class="fc2-grab" aria-hidden="true"></div>

    <header class="fc2-shead">
      <div>
        <h3 id="fc2-title-m" class="fc2-title">{brand?.name || "Insurance Services"}</h3>
        <p class="fc2-sub">
          {brand?.primaryArea || "Chennai Outskirts"} • {brand?.hours?.label || "Open 24 hours"}
        </p>
      </div>
      <button class="fc2-x" type="button" aria-label="Close" data-fc2-close>×</button>
    </header>

    <div class="fc2-body">
      <div class="fc2-info">
        <div class="fc2-row">
          <span class="fc2-k">Call</span>
          <a class="fc2-v fc2-link" href={telHref}>{brand?.phone || brand?.phoneE164}</a>
        </div>

        <div class="fc2-row">
          <span class="fc2-k">WhatsApp</span>
          <a class="fc2-v fc2-link" href={waHref} target="_blank" rel="noopener">Open chat</a>
        </div>

        <div class="fc2-row">
          <span class="fc2-k">Maps</span>
          {mapsHref !== "#" ? (
            <a class="fc2-v fc2-link" href={mapsHref} target="_blank" rel="noopener">Open location</a>
          ) : (
            <span class="fc2-v fc2-muted">Add gbpUrl</span>
          )}
        </div>

        <div class="fc2-row">
          <span class="fc2-k">Address</span>
          {addrLine ? <span class="fc2-v">{addrLine}</span> : <span class="fc2-v fc2-muted">Add streetAddress</span>}
        </div>
      </div>

      <div class="fc2-actions fc2-actions--sheet">
        <a class="fc2-a fc2-a--primary" href={telHref}>Call</a>
        <a class="fc2-a" href={waHref} target="_blank" rel="noopener">WhatsApp</a>
        {mapsHref !== "#" ? (
          <a class="fc2-a" href={mapsHref} target="_blank" rel="noopener">Maps</a>
        ) : null}
      </div>
    </div>
  </section>
</div>

<script is:inline>
  (function () {
    const trigger = document.querySelector("[data-fc2-trigger]");
    const overlay = document.querySelector("[data-fc2-overlay]");
    if (!trigger || !overlay) return;

    // ✅ IMPORTANT: move overlay to <body> so BaseLayout stacking/overflow cannot clip it
    if (overlay.parentElement !== document.body) {
      document.body.appendChild(overlay);
    }

    const desktopPanel = overlay.querySelector('[data-fc2-panel="desktop"]');
    const mobilePanel = overlay.querySelector('[data-fc2-panel="mobile"]');
    const closeEls = overlay.querySelectorAll("[data-fc2-close]");

    const isMobile = () => window.matchMedia("(max-width: 820px)").matches;

    let lastActive = null;

    function positionDesktopPopover() {
      // Anchor popover above the floating button
      const btn = trigger.getBoundingClientRect();
      const pad = 12;
      const popW = desktopPanel.offsetWidth || 420;
      const popH = desktopPanel.offsetHeight || 520;

      const right = Math.max(pad, window.innerWidth - btn.right);
      const bottom = Math.max(pad, window.innerHeight - btn.top + 10); // pop above button

      // Use right/bottom so it stays bottom-right aligned
      desktopPanel.style.right = right + "px";
      desktopPanel.style.bottom = bottom + "px";

      // Prevent off-screen top
      const topIf = window.innerHeight - bottom - popH;
      if (topIf < pad) {
        // If too tall, clamp
        desktopPanel.style.maxHeight = "70vh";
      }
    }

    function open() {
      lastActive = document.activeElement;
      overlay.hidden = false;
      document.body.classList.add("fc2-lock");
      trigger.setAttribute("aria-expanded", "true");

      if (isMobile()) {
        desktopPanel.style.display = "none";
        mobilePanel.style.display = "block";
        requestAnimationFrame(() => mobilePanel.classList.add("is-open"));
        mobilePanel.focus();
      } else {
        mobilePanel.classList.remove("is-open");
        mobilePanel.style.display = "none";
        desktopPanel.style.display = "block";
        requestAnimationFrame(() => {
          desktopPanel.classList.add("is-open");
          positionDesktopPopover();
        });
        desktopPanel.focus();
      }
    }

    function close() {
      desktopPanel.classList.remove("is-open");
      mobilePanel.classList.remove("is-open");
      setTimeout(() => {
        overlay.hidden = true;
        document.body.classList.remove("fc2-lock");
        trigger.setAttribute("aria-expanded", "false");
        if (lastActive && typeof lastActive.focus === "function") lastActive.focus();
      }, 160);
    }

    trigger.addEventListener("click", open);
    closeEls.forEach((el) => el.addEventListener("click", close));

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !overlay.hidden) close();
    });

    window.addEventListener("resize", () => {
      if (overlay.hidden) return;
      if (!isMobile()) positionDesktopPopover();
    });

    // If your layout hydrates/changes, re-position once after load
    window.addEventListener("load", () => {
      if (!overlay.hidden && !isMobile()) positionDesktopPopover();
    });
  })();
</script>
