---
import { siteData } from "src/content/siteData";

const { brand } = Astro.props;

const en = (path = "/") => {
  const clean = (path || "/").replace(/^\/+/, "");
  const base = `/en/${clean}`.replace(/\/{2,}/g, "/");
  return base.endsWith("/") ? base : base + "/";
};

const links = siteData.backlinks.links;
---

<!-- ONE floating trigger for both desktop + mobile -->
<div class="fm" data-fm-root>
  <button
    class="fm-btn"
    type="button"
    aria-haspopup="dialog"
    aria-controls="fm-dialog"
    aria-expanded="false"
    data-fm-open
  >
    <span class="fm-ico" aria-hidden="true">≡</span>
    <span class="fm-text">Menu</span>
  </button>

  <dialog class="fm-dialog" id="fm-dialog" data-fm-dialog aria-label="Menu">
    <div class="fm-panel" role="document">
      <header class="fm-head">
        <div class="fm-headtxt">
          <div class="fm-title">{brand?.name || "Menu"}</div>
          <div class="fm-sub">{brand?.primaryArea || ""}</div>
        </div>
        <button class="fm-x" type="button" aria-label="Close menu" data-fm-close>×</button>
      </header>

      <nav aria-label="Menu links">
        <ul class="fm-list">
          {links.map((x) => (
            <li class="fm-item">
              <a class="fm-a" href={x.href} data-fm-navlink>{x.label}</a>
            </li>
          ))}
        </ul>
      </nav>
    </div>
  </dialog>
</div>

<style is:global>
  /* ===== OPEN STATE ===== */
  :global(body.fc2-menu-open) { overflow: hidden; }

  /* Hide other floating buttons when menu is open (match your CTA roots) */
  :global(body.fc2-menu-open .fc2-wrap),
  :global(body.fc2-menu-open .floating-contact),
  :global(body.fc2-menu-open [data-fc2-root]) {
    display: none !important;
  }

  /* ===== TRIGGER POSITION (DESKTOP TOP-RIGHT / MOBILE BOTTOM-RIGHT) ===== */
  .fm {
    position: fixed;
    z-index: 9999;
  }

  /* Desktop: top-right */
  @media (min-width: 821px) {
    .fm { top: 18px; right: 18px; }
  }

  /* Mobile: bottom-right */
  @media (max-width: 820px) {
    .fm { right: 16px; bottom: 92px; } /* keep above your contact bar */
  }

  .fm-btn{
    height: 48px;
    border-radius: 999px;
    border: 1px solid var(--border, #e7e9ee);
    background: var(--surface, #fff);
    box-shadow: 0 14px 40px rgba(11,13,18,.10);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 0 14px;
  }

  .fm-ico{
    width: 34px; height: 34px;
    border-radius: 999px;
    display:grid;
    place-items:center;
    background: var(--text, #0b0d12);
    color:#fff;
    font-weight: 900;
    line-height: 1;
  }
  .fm-text{
    font-weight: 900;
    font-size: 13px;
    letter-spacing: -0.01em;
    color: var(--text, #0b0d12);
  }

  /* ===== DIALOG BASE ===== */
  .fm-dialog{
    padding: 0;
    border: 0;
    background: transparent;
  }
  .fm-dialog::backdrop{
    background: rgba(11,13,18,.45);
    backdrop-filter: blur(6px);
  }

  /* ===== PANEL (desktop popover / mobile sheet) ===== */
  .fm-panel{
    background: var(--surface, #fff);
    border: 1px solid var(--border, #e7e9ee);
    box-shadow: 0 14px 40px rgba(11,13,18,.12);
    overflow: hidden;
  }

  /* Desktop popover: top-right card */
  @media (min-width: 821px){
    .fm-dialog{
      width: 1px; height: 1px; /* dialog itself is just a container */
    }
    .fm-panel{
      position: fixed;
      top: 70px;           /* below button */
      right: 18px;
      width: 270px;
      border-radius: 18px;
    }
  }

  /* Mobile sheet: full-width, bottom-style */
  @media (max-width: 820px){
    .fm-dialog{
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;
    }
    .fm-panel{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      border-radius: 22px;
      max-height: 78vh;
      display: flex;
      flex-direction: column;
    }
  }

  .fm-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    padding: 14px 14px 12px;
    border-bottom: 1px solid var(--border, #e7e9ee);
  }
  .fm-title{
    font-weight: 950;
    font-size: 15px;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }
  .fm-sub{
    margin-top: 4px;
    color: var(--muted, #5b616e);
    font-size: 12.5px;
  }

  .fm-x{
    width: 40px; height: 40px;
    border-radius: 999px;
    border: 1px solid var(--border, #e7e9ee);
    background: var(--surface, #fff);
    cursor: pointer;
    font-size: 20px;
    display:grid;
    place-items:center;
    line-height: 1;
  }

  .fm-list{
    list-style:none;
    padding: 8px 12px 12px;
    margin: 0;
  }

  /* Mobile should scroll if needed */
  @media (max-width: 820px){
    .fm-list{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1;
    }
  }

  .fm-a{
    display:block;
    padding: 12px 12px;
    border-radius: 14px;
    font-weight: 900;
    font-size: 14px;
    color: var(--text, #0b0d12);
  }
  .fm-a:hover{ background: var(--surface-2, #f6f7f9); }
  .fm-a:active{ background: var(--surface-2, #f6f7f9); }
</style>

<script is:inline>
  (function () {
    const root = document.querySelector("[data-fm-root]");
    if (!root) return;

    const btnOpen = root.querySelector("[data-fm-open]");
    const btnClose = root.querySelector("[data-fm-close]");
    const dialog = root.querySelector("[data-fm-dialog]");
    const navLinks = root.querySelectorAll("[data-fm-navlink]");

    const hasDialog = !!(dialog && typeof dialog.showModal === "function");

    const setOpenState = (open) => {
      btnOpen?.setAttribute("aria-expanded", String(!!open));
      document.body.classList.toggle("fc2-menu-open", !!open);
      window.dispatchEvent(new CustomEvent(open ? "fc2:menu-open" : "fc2:menu-close"));
    };

    const openMenu = () => {
      setOpenState(true);
      if (hasDialog) {
        if (!dialog.open) dialog.showModal();
      } else {
        dialog.setAttribute("open", "");
        dialog.style.display = "block";
      }
    };

    const closeMenu = () => {
      setOpenState(false);
      if (hasDialog) {
        if (dialog.open) dialog.close();
      } else {
        dialog.removeAttribute("open");
        dialog.style.display = "none";
      }
    };

    btnOpen?.addEventListener("click", (e) => { e.preventDefault(); openMenu(); });
    btnClose?.addEventListener("click", (e) => { e.preventDefault(); closeMenu(); });

    // Click outside panel closes (backdrop click)
    dialog?.addEventListener("click", (e) => {
      if (e.target === dialog) closeMenu();
    });

    // ESC closes
    dialog?.addEventListener("cancel", (e) => {
      e.preventDefault();
      closeMenu();
    });

    // Navigate closes
    navLinks.forEach((a) => a.addEventListener("click", () => closeMenu()));

    // Optional: allow other scripts to force-close menu
    window.addEventListener("fc2:force-close-menu", closeMenu);
  })();
</script>
